This file provides guidance to agents when working with code in this repository.

## Architecture Overview

This is a **flake-based NixOS system configuration** supporting multiple hosts.

### Repository Structure

```
nixos-config/
├── flake.nix                          # Entry point, defines all host configurations
├── modules/
│   └── base.nix                       # Shared settings across all hosts
├── hosts/
│   └── hestia/
│       ├── configuration.nix          # Host-specific configuration
│       └── hardware-configuration.nix # Auto-generated hardware config
```

### Configuration Structure

- **`flake.nix`**: Entry point defining NixOS system configurations
  - Tracks `nixpkgs/nixos-unstable` channel
  - Defines hosts under `nixosConfigurations` (currently: `hestia`)
  - Each host imports `modules/base.nix` plus its own `hosts/<name>/configuration.nix`

- **`modules/base.nix`**: Shared configuration for all hosts
  - Nix settings (`nix-command`, `flakes`), allowUnfree
  - User account for `hjiang` (groups: hjiang, networkmanager, wheel, users)
  - Locale (en_US.UTF-8), timezone (Asia/Shanghai)
  - Fonts, common CLI packages, zsh, openssh, printing

- **`hosts/<name>/configuration.nix`**: Host-specific configuration
  - Imports its own `hardware-configuration.nix`
  - Bootloader, kernel, hostname, networking
  - Desktop environment, audio, host-specific packages
  - `system.stateVersion`

- **`hosts/<name>/hardware-configuration.nix`**: Hardware-specific settings
  - **WARNING**: Auto-generated file - DO NOT manually edit
  - Regenerate with `nixos-generate-config` when hardware changes

### Adding a New Host

1. Create `hosts/<hostname>/` directory
2. Add `configuration.nix` with host-specific settings (imports `./hardware-configuration.nix`)
3. Copy `hardware-configuration.nix` from the target machine (generated by `nixos-generate-config`)
4. Add entry in `flake.nix`:
   ```nix
   nixosConfigurations.<hostname> = nixpkgs.lib.nixosSystem {
     system = "x86_64-linux";
     modules = [
       ./modules/base.nix
       ./hosts/<hostname>/configuration.nix
     ];
     specialArgs = { inherit zen-browser; };
   };
   ```
5. Build with `sudo nixos-rebuild switch --flake .#<hostname>`

## Common Commands

### Building and Applying Configuration

```bash
# Build and switch to new configuration (requires sudo)
sudo nixos-rebuild switch --flake .#hestia

# Build without switching (test build)
sudo nixos-rebuild build --flake .#hestia

# Test configuration without making it default
sudo nixos-rebuild test --flake .#hestia

# Build and switch, including flake updates
sudo nixos-rebuild switch --flake .#hestia --update-input nixpkgs
```

**important**: nix will ignore files not tracked by git.

### Flake Management

```bash
# Update flake.lock to latest nixpkgs-unstable
nix flake update

# Update specific input
nix flake update nixpkgs

# Show flake outputs
nix flake show

# Check flake for issues
nix flake check
```

### Package Management

```bash
# Search for packages
nix search nixpkgs <package-name>

# Add shared packages to modules/base.nix
# Add host-specific packages to hosts/<name>/configuration.nix
# Then rebuild with: sudo nixos-rebuild switch --flake .#<hostname>
```

### Testing and Validation

```bash
# Verify Nix expression syntax
nix-instantiate --parse modules/base.nix
nix-instantiate --parse hosts/hestia/configuration.nix

# Evaluate configuration (dry-run)
nixos-rebuild dry-build --flake .#hestia

# Show what would change
nixos-rebuild dry-activate --flake .#hestia
```

## Development Workflow

1. **Make changes** to the appropriate file:
   - Shared settings: `modules/base.nix`
   - Host-specific settings: `hosts/<name>/configuration.nix`
2. **Test syntax**: `nix-instantiate --parse <file>`
3. **Dry-run**: `nixos-rebuild dry-build --flake .#<hostname>`
4. **Apply changes**: `sudo nixos-rebuild switch --flake .#<hostname>`
5. **Commit** working configuration to git

## Important Notes

- **Never edit `hardware-configuration.nix` manually** - it's auto-generated per host
- The flake uses `nixos-unstable` channel, which receives frequent updates
- All `nixos-rebuild` commands must specify the flake path: `--flake .#<hostname>`
- NixOS merges `environment.systemPackages` from all imported modules automatically
- User-specific packages can be added in `users.users.hjiang.packages` or system-wide in `environment.systemPackages`
